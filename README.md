# Интернет-магазин - Дипломный проект Netology

## Описание проекта

Django REST API для интернет-магазина с функциональностью заказов, каталога товаров, корзины покупок и управления партнерами.

## Технологии

- **Backend:** Django 4.2.7, Django REST Framework 3.14.0
- **База данных:** SQLite (для разработки)
- **Асинхронные задачи:** Celery 5.3.4
- **Email:** Django Email Backend
- **Валидация:** Кастомные валидаторы
- **Тестирование:** Django Test Framework

## Установка и запуск

### 1. Клонирование репозитория
```bash
git clone https://github.com/IvanovSemjon/Netology_final_project.git
cd Netology_final_project/reference/netology_pd_diplom
```

### 2. Создание виртуального окружения
```bash
python -m venv venv
venv\Scripts\activate  # в моей Hаботе windows
```

### 3. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 4. Настройка базы данных
```bash
python manage.py makemigrations
python manage.py migrate
```

### 5. Создание суперпользователя
```bash
python manage.py createsuperuser
```

### 6. Загрузка тестовых данных
```bash
python manage.py load_shop_data --all
```

### 7. Запуск сервера
```bash
python manage.py runserver
```

Приложение будет доступно по адресу: `http://127.0.0.1:8000/`

## Структура API

### Базовые URL:
- **API:** `http://127.0.0.1:8000/api/v1/`
- **Админка:** `http://127.0.0.1:8000/admin/`

### Корневой эндпоинт API:
- **URL:** `GET /api/v1/`
- **Описание:** Возвращает информацию о доступных эндпоинтах API
- **Ответ:** JSON с описанием основных эндпоинтов


### 1. Каталог товаров (публичные эндпоинты)

#### Получить информацию об API
- **URL:** `GET /api/v1/`
- **Описание:** Возвращает список доступных эндпоинтов
- **Ответ:** `{"message": "Интернет-магазин API v1", "endpoints": {...}}`

#### Получить категории товаров
- **URL:** `GET /api/v1/categories/`
- **Ответ:** Массив категорий `[{"id": 224, "name": "Смартфоны"}]`

#### Получить список магазинов
- **URL:** `GET /api/v1/shops/`
- **Ответ:** Массив активных магазинов `[{"id": 1, "name": "Связной", "is_accepting_orders": true}]`

#### Получить товары
- **URL:** `GET /api/v1/products/`
- **Параметры (опционально):**
  - `category_id` - фильтр по категории
  - `shop_id` - фильтр по магазину
- **Ответ:** Массив товаров с ценами и параметрами


### 2. Регистрация и аутентификация

#### Регистрация пользователя
- **URL:** `POST /api/v1/user/register/`
- **Данные:** 
```json
{
  "first_name": "Иван",
  "last_name": "Иванов", 
  "email": "test@example.com",
  "password": "TestPass123",
  "company": "Тест Компания",
  "position": "Тестировщик"
}
```
- **Ответ:** `{"Status": true, "Message": "Пользователь Иван Иванов создан. Проверьте email для подтверждения регистрации."}`

#### Подтверждение email
- **URL:** `POST /api/v1/user/register/confirm/`
- **Данные:** `{"email": "test@example.com", "token": "токен_из_консоли"}`
- **Ответ:** `{"Status": true, "Message": "Email успешно подтвержден"}`

#### Вход в систему
- **URL:** `POST /api/v1/user/login/`
- **Данные:** `{"email": "test@example.com", "password": "TestPass123"}`
- **Ответ:** `{"Status": true, "Token": "токен", "Message": "Запишите Ваш токен для работы с данным сайтом"}`

### 3. Корзина и заказы (требует авторизации)

#### Добавить товары в корзину
- **URL:** `POST /api/v1/basket/`
- **Данные:** `{"items": "[{\"product_info\": 1, \"quantity\": 2}]"}`
- **Ответ:** `{"Status": true, "Message": "В заказ добавлено: 2 товара из магазина Связной"}`

#### Просмотр корзины
- **URL:** `GET /api/v1/basket/`
- **Ответ:** Массив заказов в статусе "basket"

#### Обновить количество в корзине
- **URL:** `PUT /api/v1/basket/`
- **Данные:** `{"items": [{ "id": 30, "quantity": 2 }, { "id": 31, "quantity": 5 }]}`
- **Ответ:** `{"Status": true, "Обновлено объектов": 1}`

#### Удалить товары из корзины
- **URL:** `DELETE /api/v1/basket/`
- **Данные:** `{"items": "1,2,3"}`
- **Ответ:** `{"Status": true, "Удалено объектов": 3}`

#### Создать контакт для доставки
- **URL:** `POST /api/v1/user/contact/`
- **Данные:** 
```json
{
  "city": "Москва",
  "street": "Тверская", 
  "house": "1",
  "apartment": "10",
  "phone": "+79001234567"
}
```
- **Ответ:** `{"Status": true, "Message": "Контакт для доставки успешно создан", "Contact_ID": 3}`

#### Просмотр контактов
- **URL:** `GET /api/v1/user/contact/`
- **Ответ:** Массив контактов пользователя

#### Подтвердить заказ
- **URL:** `POST /api/v1/order/`
- **Данные:** `{"id": "1", "contact": "3"}` (id корзины и id контакта)
- **Ответ:** `{"Status": true, "Message": "Заказ подтвержден. Уведомление отправлено на email."}`

#### Просмотр заказов
- **URL:** `GET /api/v1/order/`
- **Ответ:** Массив заказов пользователя (кроме корзины)

### 4. Партнерские функции (только для магазинов)

**Требует авторизации пользователя с типом "shop"**

#### Обновить прайс-лист
- **URL:** `POST /api/v1/partner/update/`
- **Вариант 1 - по URL:**
```json
{"url": "https://raw.githubusercontent.com/IvanovSemjon/Netology_final_project/main/Netology_final_project/reference/data/shop1.yaml"}
```
- **Вариант 2 - загрузка файла:** `multipart/form-data` с полем `file`
- **Ответ:** `{"Status": true, "Message": "Прайс-лист успешно изменен. Обновлено 14 товаров"}`

#### Получить статус магазина
- **URL:** `GET /api/v1/partner/state/`
- **Ответ:** `{"id": 1, "name": "Связной", "is_accepting_orders": true, "статус_заказов": "Принимает заказы"}`

#### Изменить статус магазина
- **URL:** `POST /api/v1/partner/state/`
- **Данные:** `{"state": "true"}` или `{"state": "false"}`
- **Ответ:** `{"Status": true, "Message": "Статус магазина успешно изменен"}`

#### Получить заказы магазина
- **URL:** `GET /api/v1/partner/orders/`
- **Ответ:** Массив заказов с товарами данного магазина

#### Изменить статус заказа
- **URL:** `POST /api/v1/partner/orders/status/`
- **Данные:** 
```json
{
  "order_id": "1",
  "status": "confirmed"
}
```
- **Доступные статусы:** `confirmed`, `assembled`, `sent`, `delivered`
- **Ответ:** `{"Status": true, "Message": "Статус заказа #1 изменен на \"Подтвержден\""}`

## Настройка магазина

### Создание пользователя-магазина через админку:

1. **Войдите в админку:** `http://127.0.0.1:8000/admin/`
2. **Создайте пользователя:**
   - **BACKEND → Пользователи → Добавить пользователя**
   - Email: `shop@example.com`
   - Password: `ShopPass123`
   - Type: **"Магазин"** (shop)
   - Active: ✓
3. **Создайте магазин:**
   - **BACKEND → Магазины → Добавить магазин**
   - Name: `Тестовый магазин`
   - User: выберите созданного пользователя
   - Accepting orders: ✓

## Пошаговое тестирование

### Сценарий 1: Покупатель
1. Регистрация → Подтверждение email → Вход
2. Просмотр товаров → Добавление в корзину
3. Создание контакта → Подтверждение заказа
4. Просмотр статуса заказа

### Сценарий 2: Магазин
1. Вход как магазин → Загрузка прайс-листа
2. Включение приема заказов
3. Просмотр поступивших заказов
4. Изменение статусов заказов

## Коды ошибок

- **200** - Успешный запрос
- **403** - Требуется авторизация или недостаточно прав
- **404** - Ресурс не найден
- **500** - Внутренняя ошибка сервера

## Примеры ответов с ошибками

```json
{"Status": false, "Error": "Log in required"}
{"Status": false, "Error": "Только для магазинов"}
{"Status": false, "Errors": "Не указаны все необходимые аргументы"}
{"Status": false, "Errors": {"email": ["Пользователь с таким email уже существует"]}}
```

## Postman коллекция

### Переменные окружения:
- `base_url`: `http://127.0.0.1:8000`
- `token`: (заполняется после авторизации)
- `user_token`: токен покупателя
- `shop_token`: токен магазина

### Основные запросы:
```
GET {{base_url}}/api/v1/                    # Информация об API
GET {{base_url}}/api/v1/categories/         # Категории
GET {{base_url}}/api/v1/products/           # Товары
POST {{base_url}}/api/v1/user/login/        # Авторизация
POST {{base_url}}/api/v1/basket/            # Добавить в корзину
POST {{base_url}}/api/v1/order/             # Подтвердить заказ
GET {{base_url}}/api/v1/partner/orders/     # Заказы магазина
```

## Структура проекта

```
backend/
├── api/
│   ├── serializers/     # Сериализаторы по модулям
│   ├── views/           # API views по функциональности
│   ├── permissions.py   # Кастомные разрешения
│   └── urls.py         # API маршруты
├── models/             # Модели данных
├── services/           # Бизнес-логика
├── tasks/              # Celery задачи
├── tests/              # Тесты
├── management/         # Django команды
└── admin.py           # Настройки админки
```

## Особенности реализации

- **Токенная аутентификация** - безопасная авторизация через токены
- **Разделение ролей** - покупатели и магазины с разными правами
- **Корзина как заказ** - корзина это заказ в статусе "basket"
- **Мультимагазинность** - один товар может продаваться в разных магазинах
- **История статусов** - отслеживание изменений статуса заказа
- **Валидация данных** - проверка корректности всех входных данных
- **Информативные ответы** - понятные сообщения об успехе и ошибках

## Функциональность

### Для покупателей:
- ✅ Регистрация и подтверждение email
- ✅ Просмотр каталога товаров с фильтрацией
- ✅ Добавление товаров в корзину
- ✅ Управление корзиной (добавление, изменение, удаление)
- ✅ Создание контактов для доставки
- ✅ Оформление заказов
- ✅ Просмотр истории заказов

### Для магазинов:
- ✅ Загрузка прайс-листов (URL или файл)
- ✅ Управление статусом приема заказов
- ✅ Просмотр поступивших заказов
- ✅ Изменение статусов заказов
- ✅ Автоматическое создание товаров и категорий

### Административные функции:
- ✅ Управление пользователями и магазинами
- ✅ Просмотр всех заказов и товаров
- ✅ Русскоязычный интерфейс админки
- ✅ История изменений статусов заказов

## Контакты

**Автор:** Иванов Семён  
**Телефон:** +7-999-968-2498  
**Email:** ivanovsemjon@yandex.ru  
**GitHub:** https://github.com/IvanovSemjon/Netology_final_project  
**Проект:** Дипломная работа Netology - Django REST API интернет-магазина